<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>BGM Player</title>
  </head>
  <body>
    <audio id="bgm" loop autoplay></audio>
    <script>
      const audio = document.getElementById('bgm');

      window.addEventListener('message', (e) => {
        const { bgm, currentTime, type } = e.data || {};

        if (type === 'requestCurrentTime') {
          e.source?.postMessage(
            { type: 'responseCurrentTime', currentTime: audio.currentTime },
            '*',
          );
          return;
        }

        if (type === 'setBgm') {
          if (!bgm) {
            audio.pause();
            audio.removeAttribute('src');
            audio.load();
            return;
          }

          const expectedSrc = location.origin + '/kiwiSisters/music/' + bgm;
          const time = typeof currentTime === 'number' && !isNaN(currentTime)
            ? currentTime
            : 0;

          if (audio.src !== expectedSrc) {
            audio.src = expectedSrc;
            audio.onloadedmetadata = () => {
              audio.currentTime = time;
              audio.play().catch(console.warn);
            };
          } else {
            audio.currentTime = time;
            audio.play().catch(console.warn);
          }
          return;
        }

        if (type === 'saveCurrentTime') {
          if (!audio.paused) {
            sessionStorage.setItem('bgmTime', audio.currentTime);
            sessionStorage.setItem('lastBgm', audio.src.split('/').pop());
            console.log('ğŸ’¾ å†ç”Ÿä½ç½®ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', audio.currentTime);
          }
        }
      });
    </script>
  </body>
</html>
