<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>BGM Player</title>
  </head>
  <body>
    <audio id="bgm" loop autoplay preload="auto"></audio>
    <script>
      const audio = document.getElementById('bgm')

      const bgmMap = {
        æ¢ç´¢: 'tansaku.mp3',
        æ¢ç´¢_ä¸ç©: 'tansaku_fuon.mp3',
        æ±ºå®š: 'kettei.mp3',
        é¸æŠ: 'select.mp3',
        ãƒ—ãƒ­ã‚°ãƒ©ãƒ : 'program.mp3',
        èŠ±å­: 'hanako.mp3',
        ãƒ™ãƒˆãƒ¢ãƒ„: 'betomotu.mp3',
        ãƒ“ã‚¸ãƒ¥ãƒ„: 'bijyutu.mp3',
        ãƒ¯ãƒ«ãƒ„: 'warutu.mp3',
        æ€ªã—ã„: 'ayasii.mp3',
        å±æ©Ÿ: 'kiki.mp3',
        ç™ºè¦‹: 'hakken.mp3',
        ã‚¢ãƒ³ã‚´ãƒ©: 'kiwi.mp3',
        ç«‹ã¡å‘ã‹ã†: 'tachimukau.mp3',
        ãµã‚Šãµã‚Š: 'kawaii.mp3',
        ãŠãµã–ã‘: 'otoboke.mp3',
        å›æƒ³: 'kaisou.mp3',
        å›æƒ³2: 'kaisou2.mp3',
        å…ˆç”Ÿ: 'teacher.mp3',
        å¿—ä¹ƒ: 'sino.mp3',
        ç¥–æ¯: 'sobo.mp3',
        ãƒãƒ¼ãƒãƒ«ã‚¨ãƒ³ãƒ‰: 'normalEnd.mp3',
        ãƒˆã‚¥ãƒ«ãƒ¼ã‚¨ãƒ³ãƒ‰: 'true.mp3',
        ç¥éš ã—ã®çœŸç›¸: 'end.mp3',
        é™æ­¢: '',
      }

      const bgmFiles = Object.values(bgmMap).filter((f) => f !== '')
      bgmFiles.forEach((filename) => {
        const preloadAudio = new Audio()
        preloadAudio.src = `${location.origin}/music/${filename}`
        preloadAudio.preload = 'auto'
      })

      let lastBgmName = null
      let lastFile = null

      // ğŸ”§ è¿½åŠ : æ­£è¦åŒ–é–¢æ•°
      function normalizeBgmName(str) {
        return str
          .replace(/[\u200B-\u200D\uFEFF]/g, '') // ã‚¼ãƒ­å¹…ã‚¹ãƒšãƒ¼ã‚¹å‰Šé™¤
          .replace(/\s+/g, '') // åŠè§’/å…¨è§’ç©ºç™½å‰Šé™¤
          .trim()
      }

      async function safePlay(currentTime) {
        try {
          audio.currentTime = currentTime
          await audio.play()
          console.log('âœ… BGMå†ç”ŸæˆåŠŸ')
          sessionStorage.removeItem('bgmPlayFailed')
        } catch (err) {
          console.warn('ğŸ”‡ BGMå†ç”Ÿå¤±æ•—ï¼ˆè‡ªå‹•ï¼‰:', err)
          sessionStorage.setItem('bgmPlayFailed', 'true')
        }
      }

      window.addEventListener('DOMContentLoaded', () => {
        const filename = sessionStorage.getItem('lastBgm')
        const bgmTime = parseFloat(sessionStorage.getItem('bgmTime') || '0')

        if (filename) {
          const expectedSrc = `${location.origin}/music/${filename}`
          audio.src = `${expectedSrc}?v=${Date.now()}`
          audio.onloadedmetadata = () => {
            console.log(
              `ğŸ“¥ ãƒªãƒ­ãƒ¼ãƒ‰æ™‚BGMãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã®ã¿: ${filename} â±ï¸ ä½ç½®: ${bgmTime}`,
            )
          }
        }
      })

      window.addEventListener('message', async (e) => {
        const { bgm, currentTime, type } = e.data || {}

        if (type === 'requestCurrentTime') {
          e.source?.postMessage(
            { type: 'responseCurrentTime', currentTime: audio.currentTime },
            '*',
          )
          return
        }

        if (type === 'retryPlay') {
          console.log('ğŸ” ã‚¯ãƒªãƒƒã‚¯å¾Œã«å†ç”Ÿå†è©¦è¡Œ')
          const time = parseFloat(sessionStorage.getItem('bgmTime') || '0')
          safePlay(time)
          return
        }

        if (type === 'setBgm') {
          let targetBgmName =
            typeof bgm === 'string' ? normalizeBgmName(bgm) : ''
          let filename = ''

          console.log(`ğŸ¯ æ­£è¦åŒ–å¾Œ targetBgmName='${targetBgmName}'`)

          if (targetBgmName === '' || targetBgmName === 'é™æ­¢') {
            audio.pause()
            audio.removeAttribute('src')
            audio.load()
            lastBgmName = null
            lastFile = null
            sessionStorage.removeItem('bgmTime')
            sessionStorage.removeItem('bgmPlayFailed')
            console.log('ğŸ”‡ BGMåœæ­¢ï¼ˆç©ºæ¬„/é™æ­¢ï¼‰')
            return
          }

          filename = bgmMap[targetBgmName] || ''

          if (filename === '') {
            console.log(`âš ï¸ bgmMap ã« '${targetBgmName}' ãŒæœªå®šç¾© â†’ ç„¡éŸ³åŒ–`)
            audio.pause()
            audio.removeAttribute('src')
            audio.load()
            lastBgmName = null
            lastFile = null
            sessionStorage.removeItem('bgmTime')
            sessionStorage.removeItem('bgmPlayFailed')
            return
          }

          const expectedSrc = `${location.origin}/music/${filename}`
          const savedTime = parseFloat(sessionStorage.getItem('bgmTime') || '0')

          if (lastFile === filename && audio.src.endsWith(filename)) {
            console.log('ğŸ” audio.src =', audio.src)
            console.log('ğŸ” lastFile =', lastFile)
            console.log('ğŸµ BGMå¤‰æ›´ãªã— â†’ å†ç”Ÿä½ç½®ã ã‘æ›´æ–°')
            safePlay(savedTime)
            return
          }

          audio.src = `${expectedSrc}?v=${Date.now()}`
          audio.onloadedmetadata = () => {
            safePlay(savedTime)
            console.log(`ğŸµ BGMå†ç”Ÿ: ${filename} â±ï¸ å†é–‹ä½ç½®: ${savedTime}`)
          }

          lastBgmName = targetBgmName
          lastFile = filename
          sessionStorage.setItem('lastBgm', filename)
        }

        if (type === 'saveCurrentTime') {
          if (!audio.paused) {
            sessionStorage.setItem('bgmTime', audio.currentTime)
            sessionStorage.setItem('lastBgm', lastFile || '')
            console.log('ğŸ’¾ å†ç”Ÿä½ç½®ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', audio.currentTime)
          }
        }
      })
    </script>
  </body>
</html>
