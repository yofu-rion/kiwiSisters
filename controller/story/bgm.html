<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>BGM Player</title>
  </head>
  <body>
    <audio id="bgm" loop autoplay></audio>
    <script>
      const audio = document.getElementById('bgm');

      const bgmMap = {
        'æ¢ç´¢': 'tansaku.mp3',
        'æ¢ç´¢_ä¸ç©': 'tansaku_fuon.mp3',
        'æ±ºå®š': 'kettei.mp3',
        'é¸æŠ': 'select.mp3',
        'ãƒ—ãƒ­ã‚°ãƒ©ãƒ ': 'program.mp3',
        'èŠ±å­': 'hanako.mp3',
        'æ€ªã—ã„': 'ayasii.mp3',
        'æ€ªã—ã„2': 'ayasii2.mp3',
        'é™æ­¢': '',
      };

      let lastBgmName = null;
      let lastFile = null;

      window.addEventListener('message', (e) => {
        const { bgm, currentTime, type } = e.data || {};

        if (type === 'requestCurrentTime') {
          e.source?.postMessage({ type: 'responseCurrentTime', currentTime: audio.currentTime }, '*');
          return;
        }

        if (type === 'setBgm') {
          let targetBgmName = (typeof bgm === 'string') ? bgm.trim() : '';
          let filename = '';

          if (targetBgmName === '') {
            if (lastFile) {
              filename = lastFile;
              targetBgmName = lastBgmName;
              console.log('â© ç©ºæ¬„ãªã®ã§å‰å›ã‚’ç¶™ç¶š:', filename);
            } else {
              console.log('â›” ç©ºæ¬„ã‹ã¤å‰å›æƒ…å ±ãªã— â†’ ç„¡éŸ³ç¶­æŒ');
              return;
            }
          } else {
            filename = bgmMap[targetBgmName] || '';
          }

          if (targetBgmName === 'é™æ­¢' || filename === '') {
            audio.pause();
            audio.removeAttribute('src');
            audio.load();
            lastBgmName = null;
            lastFile = null;
            sessionStorage.removeItem('bgmTime');
            sessionStorage.removeItem('lastBgm');
            console.log('ğŸ”‡ BGMåœæ­¢ï¼ˆé™æ­¢ï¼‰');
            return;
          }

          const expectedSrc = `${location.origin}/kiwiSisters/music/${filename}`;
          const savedTime = parseFloat(sessionStorage.getItem('bgmTime') || '0');
          const savedBgm = sessionStorage.getItem('lastBgm') || '';

          // ğŸ§  ã™ã§ã«åŒã˜BGMãŒæµã‚Œã¦ã„ã‚‹ãªã‚‰å†è¨­å®šã›ãšç¶™ç¶šå†ç”Ÿ
          if (lastFile === filename && audio.src.endsWith(filename)) {
            console.log('ğŸµ BGMå¤‰æ›´ãªã— â†’ å†ç”Ÿä½ç½®ã ã‘æ›´æ–°');
            audio.currentTime = savedTime;
            audio.play().catch(console.warn);
            return;
          }

          // ğŸ”„ BGMåˆ‡ã‚Šæ›¿ãˆ or åˆå›è¨­å®š
          audio.src = expectedSrc;
          audio.onloadedmetadata = () => {
            audio.currentTime = savedTime;
            audio.play().catch(console.warn);
            console.log(`ğŸµ BGMå†ç”Ÿ: ${filename} â±ï¸ å†é–‹ä½ç½®: ${savedTime}`);
          };

          lastBgmName = targetBgmName;
          lastFile = filename;
          sessionStorage.setItem('lastBgm', filename);
        }

        if (type === 'saveCurrentTime') {
          if (!audio.paused) {
            sessionStorage.setItem('bgmTime', audio.currentTime);
            sessionStorage.setItem('lastBgm', lastFile || '');
            console.log('ğŸ’¾ å†ç”Ÿä½ç½®ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', audio.currentTime);
          }
        }
      });
    </script>
  </body>
</html>
