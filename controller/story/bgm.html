<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>BGM Player</title>
  </head>
  <body>
    <audio id="bgm" loop autoplay></audio>
    <script>
      const audio = document.getElementById('bgm')

      const bgmMap = {
        æ¢ç´¢: 'tansaku.mp3',
        æ¢ç´¢_ä¸ç©: 'tansaku_fuon.mp3',
        æ±ºå®š: 'kettei.mp3',
        é¸æŠ: 'select.mp3',
        ãƒ—ãƒ­ã‚°ãƒ©ãƒ : 'program.mp3',
        èŠ±å­: 'hanako.mp3',
        æ€ªã—ã„: 'ayasii.mp3',
        å±æ©Ÿ: 'kiki.mp3',
        ç™ºè¦‹: 'hakken.mp3',
        é™æ­¢: '',
      }

      let lastBgmName = null
      let lastFile = null

      // ğŸ” play() ã‚’å®‰å…¨ã«å‘¼ã³å‡ºã™å…±é€šé–¢æ•°
      async function safePlay(currentTime) {
        try {
          audio.currentTime = currentTime
          await audio.play()
          console.log('âœ… BGMå†ç”ŸæˆåŠŸ')
          sessionStorage.removeItem('bgmPlayFailed')
        } catch (err) {
          console.warn('ğŸ”‡ BGMå†ç”Ÿå¤±æ•—ï¼ˆè‡ªå‹•ï¼‰:', err)
          sessionStorage.setItem('bgmPlayFailed', 'true')
        }
      }

      window.addEventListener('DOMContentLoaded', () => {
        const filename = sessionStorage.getItem('lastBgm')
        const bgmTime = parseFloat(sessionStorage.getItem('bgmTime') || '0')

        if (filename) {
          const expectedSrc = `${location.origin}/kiwiSisters/music/${filename}`
          audio.src = expectedSrc
          audio.onloadedmetadata = () => {
            // å†ç”Ÿã¯ã—ãªã„ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œã§å†é–‹ã•ã›ã‚‹ï¼‰
            console.log(
              `ğŸ“¥ ãƒªãƒ­ãƒ¼ãƒ‰æ™‚BGMãƒ—ãƒªãƒ­ãƒ¼ãƒ‰ã®ã¿: ${filename} â±ï¸ ä½ç½®: ${bgmTime}`,
            )
          }
        }
      })

      window.addEventListener('message', async (e) => {
        const { bgm, currentTime, type } = e.data || {}

        if (type === 'requestCurrentTime') {
          e.source?.postMessage(
            { type: 'responseCurrentTime', currentTime: audio.currentTime },
            '*',
          )
          return
        }

        if (type === 'retryPlay') {
          console.log('ğŸ” ã‚¯ãƒªãƒƒã‚¯å¾Œã«å†ç”Ÿå†è©¦è¡Œ')
          const time = parseFloat(sessionStorage.getItem('bgmTime') || '0')
          safePlay(time)
          return
        }

        if (type === 'setBgm') {
          let targetBgmName = typeof bgm === 'string' ? bgm.trim() : ''
          let filename = ''

          if (targetBgmName === '' || targetBgmName === 'é™æ­¢') {
            // ğŸ”‡ ç©ºæ¬„ or é™æ­¢ãªã‚‰å³åœæ­¢
            audio.pause()
            audio.removeAttribute('src')
            audio.load()
            lastBgmName = null
            lastFile = null
            sessionStorage.removeItem('bgmTime')
            sessionStorage.removeItem('bgmPlayFailed')
            console.log('ğŸ”‡ BGMåœæ­¢ï¼ˆç©ºæ¬„/é™æ­¢ï¼‰')
            return
          }

          filename = bgmMap[targetBgmName] || ''

          if (filename === '') {
            console.log(`âš ï¸ bgmMap ã« '${targetBgmName}' ãŒæœªå®šç¾© â†’ ç„¡éŸ³åŒ–`)
            audio.pause()
            audio.removeAttribute('src')
            audio.load()
            lastBgmName = null
            lastFile = null
            sessionStorage.removeItem('bgmTime')
            sessionStorage.removeItem('bgmPlayFailed')
            return
          }

          const expectedSrc = `${location.origin}/kiwiSisters/music/${filename}`
          const savedTime = parseFloat(sessionStorage.getItem('bgmTime') || '0')

          if (lastFile === filename && audio.src.endsWith(filename)) {
            console.log('ğŸµ BGMå¤‰æ›´ãªã— â†’ å†ç”Ÿä½ç½®ã ã‘æ›´æ–°')
            safePlay(savedTime)
            return
          }

          audio.src = expectedSrc
          audio.onloadedmetadata = () => {
            safePlay(savedTime)
            console.log(`ğŸµ BGMå†ç”Ÿ: ${filename} â±ï¸ å†é–‹ä½ç½®: ${savedTime}`)
          }

          lastBgmName = targetBgmName
          lastFile = filename
          sessionStorage.setItem('lastBgm', filename)
        }

        if (type === 'saveCurrentTime') {
          if (!audio.paused) {
            sessionStorage.setItem('bgmTime', audio.currentTime)
            sessionStorage.setItem('lastBgm', lastFile || '')
            console.log('ğŸ’¾ å†ç”Ÿä½ç½®ã‚’ä¿å­˜ã—ã¾ã—ãŸ:', audio.currentTime)
          }
        }
      })
    </script>
  </body>
</html>
